<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="1.0.0-1-create-all-tables" author="yustyy">
        <createTable tableName="media">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="media_type" type="VARCHAR(31)"><constraints nullable="false"/></column>
            <column name="file_name" type="VARCHAR(255)"/><column name="file_type" type="VARCHAR(100)"/><column name="file_url" type="VARCHAR(512)"/><column name="file_size" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="countries">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="name" type="VARCHAR(255)"/><column name="code" type="VARCHAR(10)"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="cities">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="name" type="VARCHAR(255)"/><column name="country_id" type="UUID"><constraints nullable="false"/></column>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="users">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="first_name" type="VARCHAR(255)"/><column name="last_name" type="VARCHAR(255)"/><column name="phone_number" type="VARCHAR(255)"/><column name="username" type="VARCHAR(255)"/><column name="email" type="VARCHAR(255)"><constraints nullable="false" unique="true"/></column>
            <column name="preferred_language" type="VARCHAR(10)"/><column name="password" type="VARCHAR(255)"/><column name="profile_picture_id" type="UUID"/><column name="birth_date" type="DATE"/><column name="gender" type="VARCHAR(50)"/><column name="tc_identity_number" type="VARCHAR(11)"/><column name="about" type="TEXT"/><column name="qualifications" type="TEXT"/><column name="experiences" type="TEXT"/><column name="interests" type="TEXT"/>
            <column name="email_verified" type="BOOLEAN" defaultValueBoolean="false"><constraints nullable="false"/></column>
            <column name="phone_verified" type="BOOLEAN" defaultValueBoolean="false"><constraints nullable="false"/></column>
            <column name="identity_verified" type="BOOLEAN" defaultValueBoolean="false"><constraints nullable="false"/></column>
            <column name="location_permission" type="BOOLEAN"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="authorities">
            <column name="user_id" type="UUID"><constraints nullable="false" primaryKey="true"/></column>
            <column name="role" type="VARCHAR(50)"><constraints nullable="false" primaryKey="true"/></column>
        </createTable>

        <createTable tableName="devices">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="user_id" type="UUID"/><column name="type" type="VARCHAR(50)"/><column name="name" type="VARCHAR(255)"/><column name="push_token" type="VARCHAR(512)"/><column name="first_seen_at" type="TIMESTAMP"/><column name="last_seen_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="sessions">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="device_id" type="UUID"><constraints nullable="false"/></column>
            <column name="token" type="VARCHAR(512)"/><column name="refresh_token" type="VARCHAR(512)"/><column name="expires_at" type="TIMESTAMP"/><column name="refresh_expires_at" type="TIMESTAMP"/><column name="ip_address" type="VARCHAR(45)"/><column name="location" type="VARCHAR(255)"/><column name="last_accessed_at" type="TIMESTAMP"/><column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="addresses">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="city_id" type="UUID"/><column name="country_id" type="UUID"/><column name="address" type="VARCHAR(255)"/><column name="user_id" type="UUID"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="user_verifications">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="verification_type" type="VARCHAR(31)"><constraints nullable="false"/></column>
            <column name="is_verified" type="BOOLEAN"/><column name="verified_by_id" type="UUID"/><column name="user_id" type="UUID"/><column name="verification_document_id" type="UUID"/>
            <column name="email" type="VARCHAR(255)"/><column name="token" type="VARCHAR(255)"/><column name="expires_at" type="TIMESTAMP"/><column name="phone_number" type="VARCHAR(255)"/><column name="tc_identity_number" type="VARCHAR(11)"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="login_attempts">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="user_id" type="UUID"/><column name="email_attempted" type="VARCHAR(255)"/><column name="is_success" type="BOOLEAN"/><column name="failure_reason" type="VARCHAR(255)"/><column name="ip_address" type="VARCHAR(255)"/><column name="device_name" type="VARCHAR(255)"/><column name="time_stamp" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="user_communication_preferences">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="user_id" type="UUID"><constraints nullable="false"/></column>
            <column name="category" type="VARCHAR(50)"/><column name="email_enabled" type="BOOLEAN" defaultValueBoolean="true"/><column name="sms_enabled" type="BOOLEAN" defaultValueBoolean="true"/><column name="push_enabled" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="notifications">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="recipient_id" type="UUID"/><column name="sender_id" type="UUID"/><column name="channel" type="VARCHAR(50)"/><column name="category" type="VARCHAR(50)"/><column name="destination_phone_number" type="VARCHAR(20)"/><column name="destination_email" type="VARCHAR(255)"/><column name="destination_push_token" type="VARCHAR(512)"/><column name="subject" type="VARCHAR(255)"/><column name="template_name" type="VARCHAR(255)"/><column name="template_parameters" type="TEXT"/><column name="status" type="VARCHAR(50)"/><column name="sent_at" type="TIMESTAMP"/><column name="processed_at" type="TIMESTAMP"/><column name="external_id" type="VARCHAR(255)"/><column name="failure_reason" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

        <createTable tableName="pending_registrations">
            <column name="id" type="UUID"><constraints primaryKey="true" nullable="false"/></column>
            <column name="first_name" type="VARCHAR(255)"/><column name="last_name" type="VARCHAR(255)"/><column name="email" type="VARCHAR(255)"/><column name="token" type="UUID"/><column name="expires_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP"/><column name="updated_at" type="TIMESTAMP"/><column name="created_by_id" type="UUID"/><column name="updated_by_id" type="UUID"/>
        </createTable>

    </changeSet>

    <changeSet id="1.0.0-2-add-all-foreign-keys" author="yustyy">
        <addForeignKeyConstraint baseTableName="cities" baseColumnNames="country_id" constraintName="fk_city_to_country" referencedTableName="countries" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="users" baseColumnNames="profile_picture_id" constraintName="fk_user_to_media_profilepic" referencedTableName="media" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="authorities" baseColumnNames="user_id" constraintName="fk_authorities_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="devices" baseColumnNames="user_id" constraintName="fk_device_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="sessions" baseColumnNames="device_id" constraintName="fk_session_to_device" referencedTableName="devices" referencedColumnNames="id" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="addresses" baseColumnNames="city_id" constraintName="fk_address_to_city" referencedTableName="cities" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="addresses" baseColumnNames="country_id" constraintName="fk_address_to_country" referencedTableName="countries" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="addresses" baseColumnNames="user_id" constraintName="fk_address_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="user_verifications" baseColumnNames="verified_by_id" constraintName="fk_verification_by_user" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="user_verifications" baseColumnNames="user_id" constraintName="fk_verification_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="user_verifications" baseColumnNames="verification_document_id" constraintName="fk_verification_to_media_doc" referencedTableName="media" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="login_attempts" baseColumnNames="user_id" constraintName="fk_loginattempt_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="user_communication_preferences" baseColumnNames="user_id" constraintName="fk_usercommpref_to_user" referencedTableName="users" referencedColumnNames="id" onDelete="CASCADE"/>
        <addForeignKeyConstraint baseTableName="notifications" baseColumnNames="recipient_id" constraintName="fk_notification_to_recipient" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="notifications" baseColumnNames="sender_id" constraintName="fk_notification_to_sender" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>

        <addForeignKeyConstraint baseTableName="users" baseColumnNames="created_by_id" constraintName="fk_users_created_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="users" baseColumnNames="updated_by_id" constraintName="fk_users_updated_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="devices" baseColumnNames="created_by_id" constraintName="fk_devices_created_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="devices" baseColumnNames="updated_by_id" constraintName="fk_devices_updated_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="sessions" baseColumnNames="created_by_id" constraintName="fk_session_created_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>
        <addForeignKeyConstraint baseTableName="sessions" baseColumnNames="updated_by_id" constraintName="fk_session_updated_by" referencedTableName="users" referencedColumnNames="id" onDelete="SET NULL"/>

    </changeSet>

</databaseChangeLog>